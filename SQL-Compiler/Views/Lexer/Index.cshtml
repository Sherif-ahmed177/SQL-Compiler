@{
    ViewData["Title"] = "Syntax Analyzer";
}

<div class="row g-4 page-content">
    <!-- LEFT PANEL: Editor -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">SQL Input</h5>
                <div>
                    <button id="uploadBtn" class="btn btn-sm btn-outline-primary" title="Upload File"><i class="bi bi-upload"></i> Upload</button>
                    <input type="file" id="fileInput" accept=".txt,.sql" class="d-none" />
                    <button id="exampleBtn" class="btn btn-sm btn-outline-secondary" title="Load Example">Example</button>
                    <button id="clearBtn" class="btn btn-sm btn-outline-danger" title="Clear">Clear</button>
                </div>
            </div>
            
            <div class="card-body d-flex flex-column">
                <textarea id="inputCode" class="form-control code-editor flex-grow-1 mb-3" 
                          rows="15"
                          spellcheck="false" 
                          placeholder="SELECT * FROM students WHERE id = 1;"></textarea>
                
                <div id="errorBox" class="alert alert-danger d-none mb-3 py-2 px-3 small">
                    <strong>Error:</strong> <span id="errorMsg"></span>
                </div>

                <div class="d-grid">
                    <button id="analyzeBtn" class="btn btn-primary">
                        <span id="btnText">Analyze Code</span>
                        <div id="analyzeSpinner" class="spinner-border spinner-border-sm d-none"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT PANEL: Results -->
    <div class="col-lg-8">
        <!-- Status Bar -->
        <div id="statusBar" class="status-bar pending">
            <i class="bi bi-hourglass-split"></i>
            <span id="statusText">Ready to analyze</span>
        </div>
        
        <div class="card h-100" style="border-top-left-radius: 0; border-top-right-radius: 0;">
            <div class="card-header bg-light p-0">
                <ul class="nav nav-tabs card-header-tabs m-0" id="resultTabs" role="tablist">
                    <li class="nav-item ms-3">
                        <button class="nav-link active border-0 py-3" id="tree-tab" data-bs-toggle="tab" data-bs-target="#tree-pane" type="button">Parse Tree</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link border-0 py-3" id="tokens-tab" data-bs-toggle="tab" data-bs-target="#tokens-pane" type="button">Tokens</button>
                    </li>
                </ul>
            </div>

            <div class="card-body p-0 overflow-hidden" style="min-height: 500px;">
                <div class="tab-content h-100">
                    
                    <!-- TAB 1: PARSE TREE -->
                    <div class="tab-pane fade show active h-100" id="tree-pane" role="tabpanel">
                        <div class="h-100 position-relative border bg-light overflow-hidden d-flex flex-column">
                            <!-- Zoom Controls -->
                            <div class="position-absolute top-0 end-0 m-3 btn-group z-3" role="group">
                                <button type="button" class="btn btn-sm btn-light border shadow-sm" id="zoomIn" title="Zoom In"><i class="bi bi-plus-lg"></i></button>
                                <button type="button" class="btn btn-sm btn-light border shadow-sm" id="zoomOut" title="Zoom Out"><i class="bi bi-dash-lg"></i></button>
                                <button type="button" class="btn btn-sm btn-light border shadow-sm" id="zoomReset" title="Reset"><i class="bi bi-arrow-counterclockwise"></i></button>
                            </div>

                            <!-- Syntax Errors Display -->
                            <div id="syntaxErrorBox" class="d-none border-bottom border-danger bg-danger bg-opacity-10 p-3">
                                <h6 class="text-danger mb-2"><i class="bi bi-exclamation-triangle-fill me-2"></i>Syntax Errors</h6>
                                <div id="syntaxErrorList" class="small font-monospace text-danger"></div>
                            </div>

                            <div class="flex-grow-1 tree-container" id="treeContainer">
                                <div id="treeEmptyState" class="text-center text-muted py-5 mt-5">
                                    <p class="lead">Run analysis to generate the syntax tree.</p>
                                </div>
                                <!-- Tree Root -->
                                <div id="treeView" class="tree d-none"></div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 2: TOKENS -->
                    <div class="tab-pane fade h-100" id="tokens-pane" role="tabpanel">
                        <div class="h-100 overflow-auto p-3">
                            <table class="table table-hover table-bordered table-sm">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Type</th>
                                        <th>Lexeme</th>
                                        <th>Line</th>
                                        <th>Column</th>
                                    </tr>
                                </thead>
                                <tbody id="tokenTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const el = id => document.getElementById(id);
        
        // Define Controls
        const analyzeBtn = el('analyzeBtn');
        const inputCode = el('inputCode');
        const errorBox = el('errorBox');
        const errorMsg = el('errorMsg');
        const spinner = el('analyzeSpinner');
        const btnText = el('btnText');
        
        const treeView = el('treeView');
        const treeEmpty = el('treeEmptyState');
        const tokenTable = el('tokenTableBody');
        const treeContainer = el('treeContainer');
        const statusBar = el('statusBar');
        const statusText = el('statusText');

        // Zoom Logic
        let scale = 1;
        const ZOOM_STEP = 0.1;
        
        el('zoomIn').addEventListener('click', () => {
            scale += ZOOM_STEP;
            applyZoom();
        });
        el('zoomOut').addEventListener('click', () => {
             if(scale > 0.2) { 
                scale -= ZOOM_STEP;
                applyZoom();
             }
        });
        el('zoomReset').addEventListener('click', () => {
            scale = 1;
            applyZoom();
        });

        function applyZoom() {
            treeView.style.transform = `scale(${scale})`;
            // Adjust width to compensate for scaling if needed, 
            // but transform-origin: top center handles most.
        }

        // Mouse Drag to Scroll (Pan)
        let isDown = false;
        let startX, startY, scrollLeft, scrollTop;

        treeContainer.addEventListener('mousedown', (e) => {
            isDown = true;
            treeContainer.classList.add('active-drag'); // Optional css
            startX = e.pageX - treeContainer.offsetLeft;
            startY = e.pageY - treeContainer.offsetTop;
            scrollLeft = treeContainer.scrollLeft;
            scrollTop = treeContainer.scrollTop;
            treeContainer.style.cursor = 'grabbing';
        });

        treeContainer.addEventListener('mouseleave', () => {
            isDown = false;
            treeContainer.style.cursor = 'grab';
        });

        treeContainer.addEventListener('mouseup', () => {
            isDown = false;
            treeContainer.style.cursor = 'grab';
        });

        treeContainer.addEventListener('mousemove', (e) => {
            if(!isDown) return;
            e.preventDefault();
            const x = e.pageX - treeContainer.offsetLeft;
            const y = e.pageY - treeContainer.offsetTop;
            const walkX = (x - startX) * 1.5; // Scroll-fast
            const walkY = (y - startY) * 1.5;
            treeContainer.scrollLeft = scrollLeft - walkX;
            treeContainer.scrollTop = scrollTop - walkY;
        });

        // ACTIONS
        analyzeBtn.addEventListener('click', async () => {
            const code = inputCode.value.trim();
            if(!code) return showError("Please enter some SQL code to analyze.");
            
            resetUI();
            setLoading(true);

            try {
                const res = await fetch('/Lexer/Analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(code)
                });

                if(!res.ok) throw new Error(await res.text());
                
                const data = await res.json();
                
                // Handle Syntax Errors FIRST
                const syntaxErrorBox = el('syntaxErrorBox');
                const syntaxErrorList = el('syntaxErrorList');
                
                if(data.errors && data.errors.length > 0) {
                    // ERRORS EXIST - Show errors prominently, DON'T show tree
                    syntaxErrorList.innerHTML = data.errors.map(err => 
                        `<div class="mb-1 p-2 bg-white border border-danger rounded">â€¢ ${escapeHtml(err)}</div>`
                    ).join('');
                    syntaxErrorBox.classList.remove('d-none');
                    
                    // Hide tree and show error message instead
                    treeView.classList.add('d-none');
                    treeEmpty.innerHTML = `
                        <div class="text-center text-danger py-5 mt-5">
                            <i class="bi bi-x-circle display-1"></i>
                            <h5 class="mt-3">Syntax Error(s) Found</h5>
                            <p class="text-muted">Fix the errors above to see the parse tree.</p>
                        </div>
                    `;
                    treeEmpty.classList.remove('d-none');
                    
                    // Update Status Bar - ERROR
                    statusBar.className = 'status-bar error';
                    statusText.innerHTML = `<i class="bi bi-x-circle me-2"></i>Syntax Error Detected (${data.errors.length} error${data.errors.length > 1 ? 's' : ''})`;
                    
                    // Highlight code editor with error
                    inputCode.classList.add('has-error');
                    
                    // Show in left panel
                    showError(`${data.errors.length} syntax error(s) found. See Parse Tree tab for details.`);
                } else {
                    // NO ERRORS - Show tree normally
                    syntaxErrorBox.classList.add('d-none');
                    hideError();
                    
                    // Update Status Bar - VALID
                    statusBar.className = 'status-bar valid';
                    statusText.innerHTML = '<i class="bi bi-check-circle me-2"></i>Valid Syntax';
                    
                    // Remove error highlight from code editor
                    inputCode.classList.remove('has-error');
                    
                    // Render Tree
                    if(data.tree) {
                        renderTree(data.tree);
                    }
                }
                
                // Always render tokens
                renderTokens(data.tokens);

            } catch (err) {
                showError(err.message || "An unexpected error occurred.");
            } finally {
                setLoading(false);
            }
        });

        // ----------------------------------------------------
        // VISUALIZATION LOGIC (Updated for Pure CSS Tree)
        // ----------------------------------------------------

        function renderTokens(tokens) {
            tokenTable.innerHTML = '';
            tokens.forEach(t => {
                const row = `<tr>
                    <td><span class="badge bg-light text-dark border">${t.type}</span></td>
                    <td><span class="font-monospace">${escapeHtml(t.lexeme)}</span></td>
                    <td>${t.line}</td>
                    <td>${t.column}</td>
                </tr>`;
                tokenTable.innerHTML += row;
            });
        }

        function renderTree(rootNode) {
            treeEmpty.classList.add('d-none');
            treeView.classList.remove('d-none');
            
            const ul = document.createElement('ul');
            ul.appendChild(createTreeNode(rootNode));
            treeView.innerHTML = '';
            treeView.appendChild(ul);
        }

        function createTreeNode(node) {
            const li = document.createElement('li');
            
            // Node visual
            const div = document.createElement('div');
            div.className = 'node-content';
            
            let html = '';
            if(node.name === "KEYWORD") {
                html = `<span class="node-grammar">${escapeHtml(node.name)}</span><br><span class="node-lexeme">${escapeHtml(node.lexeme)}</span>`;
            } else if (node.name === "IDENTIFIER") {
                html = `<span class="node-grammar">ID</span><br><span class="node-name">${escapeHtml(node.lexeme)}</span>`;
            } else if (node.name === "DELIMITER" || node.name === "OPERATOR") {
                html = `<span class="node-symbol">${escapeHtml(node.lexeme)}</span>`;
            } else if (node.name === "STRING" || node.name === "NUMBER" || node.name == "TYPE") {
                html = `<span class="node-grammar">${node.name}</span><br><span class="node-lexeme">${escapeHtml(node.lexeme)}</span>`;
            } else {
                // Non-terminal
                html = `<span class="node-name">${escapeHtml(node.name)}</span>`;
                if(node.lexeme) html += `<br><span class="text-muted small">${escapeHtml(node.lexeme)}</span>`;
            }
            
            div.innerHTML = html;
            li.appendChild(div);

            // Children recursion
            if (node.children && node.children.length > 0) {
                const ul = document.createElement('ul');
                node.children.forEach(child => {
                    ul.appendChild(createTreeNode(child));
                });
                li.appendChild(ul);
            }

            return li;
        }

        // ----------------------------------------------------
        // UTILITIES
        // ----------------------------------------------------

        function setLoading(isLoading) {
            analyzeBtn.disabled = isLoading;
            if(isLoading) {
                spinner.classList.remove('d-none');
                btnText.textContent = " Processing...";
            } else {
                spinner.classList.add('d-none');
                btnText.textContent = 'Analyze Code';
            }
        }

        function resetUI() {
            hideError();
            treeView.innerHTML = '';
            treeView.classList.add('d-none');
            treeEmpty.classList.remove('d-none');
            tokenTable.innerHTML = '';
        }

        function showError(msg) {
            errorMsg.innerHTML = msg;
            errorBox.classList.remove('d-none');
        }

        function hideError() {
            errorBox.classList.add('d-none');
        }

        function escapeHtml(text) {
             if(!text) return '';
             return text.replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;");
        }

        el('exampleBtn').addEventListener('click', () => {
inputCode.value = `SELECT * FROM students WHERE age >= 18;
INSERT INTO users (id, name) VALUES (1, 'Alice');`;
        });
        
        el('clearBtn').addEventListener('click', () => {
            inputCode.value = '';
            resetUI();
        });

        // File Upload
        const fileInput = el('fileInput');
        el('uploadBtn').addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                inputCode.value = e.target.result;
            };
            reader.readAsText(file);
            fileInput.value = ''; // Reset input
        });
    </script>
}
